<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Youth Counselor Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="http://localhost:35729/livereload.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-2xl mx-auto px-4 py-3 text-center">
      <h1 class="text-xl font-bold text-blue-600">ğŸ§ ì²­ì†Œë…„ ìƒë‹´ ì±—ë´‡</h1>
      <p class="text-sm text-gray-500 mt-1">ìŒì„±ìœ¼ë¡œ ì´ì•¼ê¸°í•˜ë©´ ë”°ëœ»í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜ìš”</p>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto p-4 space-y-4 w-full" id="chatContainer"></main>

  <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 w-full">
    <select id="voiceSelect" class="w-full mb-3 p-2 rounded border border-gray-300">
      <option value="alloy">Alloy</option>
      <option value="ash">Ash</option>
      <option value="coral">Coral</option>
      <option value="echo">Echo</option>
      <option value="fable">Fable</option>
      <option value="nova">Nova</option>
      <option value="onyx">Onyx</option>
      <option value="sage">Sage</option>
      <option value="shimmer" selected>Shimmer</option>
    </select>

    <div class="flex items-center gap-4 w-full">
      <button id="recordBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-medium w-full">ğŸ¤ Start</button>
      <div id="status" class="text-sm text-gray-600 whitespace-nowrap">â¹ï¸</div>
    </div>
    <div id="timer" class="text-xs text-gray-400 mt-1 hidden">00:00</div>
  </div>

  <script>
    let isRecording = false;
    let isHistoryLoaded = false;
    let recognition;
    let finalTranscript = '';
    let timerInterval;
    let seconds = 0;

    const recordBtn = document.getElementById('recordBtn');
    const statusDiv = document.getElementById('status');
    const timer = document.getElementById('timer');
    const chatContainer = document.getElementById('chatContainer');
    const voiceSelect = document.getElementById('voiceSelect');

    function formatTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startTimer() {
      seconds = 0;
      timer.textContent = formatTime(seconds);
      timer.classList.remove('hidden');
      timerInterval = setInterval(() => {
        seconds++;
        timer.textContent = formatTime(seconds);
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timer.classList.add('hidden');
    }

    function addChatBubble(message, from = 'user', saveToHistory = true) {
      const container = document.createElement('div');
      container.className = `flex items-end gap-2 ${from === 'user' ? 'justify-end' : 'justify-start'}`;

      const avatar = document.createElement('div');
      avatar.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm text-white';
      avatar.textContent = from === 'user' ? 'ğŸ™‚' : 'ğŸ¤–';
      avatar.classList.add(from === 'user' ? 'bg-gray-500' : 'bg-blue-500');

      const bubble = document.createElement('div');
      bubble.className = `rounded-xl p-3 shadow max-w-xs w-fit text-sm ${from === 'user' ? 'bg-green-100 text-right' : 'bg-white text-left'}`;
      bubble.innerHTML = message;

      if (from === 'user') {
        container.appendChild(bubble);
        container.appendChild(avatar);
      } else {
        container.appendChild(avatar);
        container.appendChild(bubble);
      }

      chatContainer.appendChild(container);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (saveToHistory) saveMessageToHistory(message, from);
      return container;
    }

    function saveMessageToHistory(message, from) {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      history.push({ from, message });
      localStorage.setItem('chatHistory', JSON.stringify(history));
    }

    function loadHistory() {
      if (isHistoryLoaded) return;
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      history.forEach(item => addChatBubble(item.message, item.from, false));
      isHistoryLoaded = true;

      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 100);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadHistory();
    });

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        let temp = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            temp += event.results[i][0].transcript;
          }
        }
        finalTranscript += temp.trim();
      };

      recognition.onend = async () => {
        if (!finalTranscript.trim()) {
          console.warn('ğŸ¤ ì•„ë¬´ í…ìŠ¤íŠ¸ë„ ì¸ì‹ë˜ì§€ ì•ŠìŒ');
          return;
        }

        const transcript = finalTranscript.trim();

        if (/reset history|ë¦¬ì…‹ íˆìŠ¤í† ë¦¬/i.test(transcript)) {
          localStorage.removeItem('chatHistory');
          chatContainer.innerHTML = '';
          isHistoryLoaded = false;
          addChatBubble('ğŸ§¹ íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆì–´ìš”.', 'bot');
          return;
        }

        addChatBubble(transcript, 'user');

        const spinnerBubble = addChatBubble(`
          <div class="flex items-center space-x-2">
            <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
            <span class="text-gray-500 text-sm">ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì´ì—ìš”...</span>
          </div>
        `, 'bot', false);

        try {
          const res = await fetch('http://localhost:8000/chat-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: transcript,
              system_prompt: "You are an experienced counselor specializing in adolescent issues. \
              Provide empathetic advice and thoughtful support in 10 or less words based on the user's text message. \
              Do not make response longer than 15 words.",
              voice: voiceSelect.value
            })
          });

          const data = await res.json();
          spinnerBubble.remove();

          if (data.text) {
            addChatBubble(data.text, 'bot');
            if (data.audio_base64) {
              const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
              audio.play();
            }
          } else {
            addChatBubble('âŒ ì‘ë‹µì´ ì—†ì–´ìš”.', 'bot');
          }
        } catch (err) {
          console.error('âŒ fetch ì—ëŸ¬:', err);
          spinnerBubble.remove();
          addChatBubble('âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
        }
      };

      recordBtn.addEventListener('click', async () => {
        if (!isRecording) {
          finalTranscript = ''; // ì´ˆê¸°í™”
          recognition?.start();
          isRecording = true;
          recordBtn.textContent = 'â¹ï¸ Stop';
          statusDiv.textContent = 'ğŸ”´';
          startTimer();
        } else {
          recognition?.stop();
          isRecording = false;
          recordBtn.textContent = 'ğŸ¤ Start';
          statusDiv.textContent = 'â¹ï¸';
          stopTimer();
        }
      });
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
    }
  </script>
</body>
</html>
