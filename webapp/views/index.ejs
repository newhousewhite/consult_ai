<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Youth Counselor Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="http://localhost:35729/livereload.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-2xl mx-auto px-4 py-3 text-center">
      <h1 class="text-xl font-bold text-blue-600">ğŸ§ ì²­ì†Œë…„ ìƒë‹´ ì±—ë´‡</h1>
      <p class="text-sm text-gray-500 mt-1">ìŒì„±ìœ¼ë¡œ ì´ì•¼ê¸°í•˜ë©´ ë”°ëœ»í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜ìš”</p>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto p-4 space-y-4 w-full" id="chatContainer"></main>

  <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 w-full">
    <select id="voiceSelect" class="w-full mb-3 p-2 rounded border border-gray-300">
      <option value="alloy">Alloy</option>
      <option value="ash">Ash</option>
      <option value="coral">Coral</option>
      <option value="echo">Echo</option>
      <option value="fable">Fable</option>
      <option value="nova">Nova</option>
      <option value="onyx">Onyx</option>
      <option value="sage">Sage</option>
      <option value="shimmer" selected>Shimmer</option>
    </select>

    <div class="flex items-center gap-4 w-full">
      <button id="recordBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-medium w-full">ğŸ¤ Start</button>
      <div id="status" class="text-sm text-gray-600 whitespace-nowrap">â¹ï¸</div>
    </div>
    <div id="timer" class="text-xs text-gray-400 mt-1 hidden">00:00</div>
  </div>

  <script>
    let isRecording = false;
    let isHistoryLoaded = false;
    let recognition;
    let finalTranscript = '';
    let timerInterval;
    let seconds = 0;

    const recordBtn = document.getElementById('recordBtn');
    const statusDiv = document.getElementById('status');
    const timer = document.getElementById('timer');
    const chatContainer = document.getElementById('chatContainer');
    const voiceSelect = document.getElementById('voiceSelect');

    function formatTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startTimer() {
      seconds = 0;
      timer.textContent = formatTime(seconds);
      timer.classList.remove('hidden');
      timerInterval = setInterval(() => {
        seconds++;
        timer.textContent = formatTime(seconds);
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timer.classList.add('hidden');
    }

    function addChatBubble(message, from = 'user', saveToHistory = true) {
      const container = document.createElement('div');
      container.className = `flex items-end gap-2 ${from === 'user' ? 'justify-end' : 'justify-start'}`;

      const avatar = document.createElement('div');
      avatar.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm text-white';
      avatar.textContent = from === 'user' ? 'ğŸ™‚' : 'ğŸ¤–';
      avatar.classList.add(from === 'user' ? 'bg-gray-500' : 'bg-blue-500');

      const bubble = document.createElement('div');
      bubble.className = `rounded-xl p-3 shadow max-w-xs w-fit text-sm ${from === 'user' ? 'bg-green-100 text-right' : 'bg-white text-left'}`;
      bubble.innerHTML = message;

      if (from === 'user') {
        container.appendChild(bubble);
        container.appendChild(avatar);
      } else {
        container.appendChild(avatar);
        container.appendChild(bubble);
      }

      chatContainer.appendChild(container);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (saveToHistory) saveMessageToHistory(message, from);
      return container;
    }

    function saveMessageToHistory(message, from) {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      history.push({ from, message });
      localStorage.setItem('chatHistory', JSON.stringify(history));
    }

    function loadHistory() {
      if (isHistoryLoaded) return;
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      history.forEach(item => addChatBubble(item.message, item.from, false));
      isHistoryLoaded = true;

      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 100);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadHistory();
    });

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        let temp = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            temp += event.results[i][0].transcript;
          }
        }
        finalTranscript += temp.trim();
      };

      recognition.onend = async () => {
        if (!finalTranscript.trim()) {
          console.warn('ğŸ¤ ì•„ë¬´ í…ìŠ¤íŠ¸ë„ ì¸ì‹ë˜ì§€ ì•ŠìŒ');
          return;
        }

        const transcript = finalTranscript.trim();

        if (/reset history|ë¦¬ì…‹ íˆìŠ¤í† ë¦¬/i.test(transcript)) {
          localStorage.removeItem('chatHistory');
          chatContainer.innerHTML = '';
          isHistoryLoaded = false;
          addChatBubble('ğŸ§¹ íˆìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆì–´ìš”.', 'bot');
          return;
        }

        addChatBubble(transcript, 'user');

        const spinnerBubble = addChatBubble(`
          <div class="flex items-center space-x-2">
            <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
            <span class="text-gray-500 text-sm">ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì´ì—ìš”...</span>
          </div>
        `, 'bot', false);

        try {
          // ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ë©´ localhost:8000 ë¶€ë¶„ ë³€ê²½ í•„ìš”
          const res = await fetch('http://localhost:8000/chat-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: transcript,
              system_prompt: "ë‹¹ì‹ ì€ ìì‚´ ìœ„í—˜ì´ ìˆëŠ” ì²­ì†Œë…„ë“¤ì„ ìœ„í•œ ì •ì„œì  ì§€ì›ê³¼ ìƒë‹´ì„ ì œê³µí•˜ëŠ” ì „ë¬¸ ì‹¬ë¦¬ìƒë‹´ ì±—ë´‡ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì„ í•­ìƒ ë”°ë¥´ì„¸ìš”:\n\n" +
                "ğŸ¯ ì—­í• ê³¼ ëª©ì \n" +
                "ë‹¹ì‹ ì˜ ì£¼ëœ ì„ë¬´ëŠ” ì²­ì†Œë…„ë“¤ì˜ ìƒëª…ì„ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.\n" +
                "ìì‚´ ì¶©ë™ì„ ëŠë¼ëŠ” ì²­ì†Œë…„ì—ê²Œ ë¹„íŒ ì—†ëŠ” ê²½ì²­, ê³µê°, ì •ì„œì  ì§€ì§€ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.\n" +
                "ì²­ì†Œë…„ì´ ìì‹ ì˜ ê°ì •ì„ í‘œí˜„í•˜ë„ë¡ ìœ ë„í•˜ë©°, ìœ„í—˜í•œ ìƒí™©ì—ì„œëŠ” ì•ˆì „í•œ ì„ íƒì„ ìœ ë„í•´ì•¼ í•©ë‹ˆë‹¤.\n" +
                "í•„ìš” ì‹œ ì „ë¬¸ì ì¸ ë„ì›€(ìƒë‹´ì‚¬, 24ì‹œê°„ ê¸´ê¸‰ ì„¼í„° ë“±)ì„ ì•ˆë‚´í•´ì•¼ í•©ë‹ˆë‹¤.\n\n" +
                "ğŸ§  ëŒ€í™” ìŠ¤íƒ€ì¼ê³¼ ì–¸ì–´\n" +
                "ë¶€ë“œëŸ½ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.\n" +
                "ì²­ì†Œë…„ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ì¹œê·¼í•˜ê³  ì§ì„¤ì ì¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.\n" +
                "íŒë‹¨í•˜ì§€ ì•Šê³ , í•­ìƒ ê³µê°í•˜ëŠ” ìì„¸ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.\n" +
                "ìì‚´ ì¶©ë™ì— ëŒ€í•´ ë§í•˜ë”ë¼ë„ ë†€ë¼ì§€ ë§ê³ , ì°¨ë¶„í•œ íƒœë„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.\n\n" +
                "ğŸ›‘ ê¸ˆì§€ ì‚¬í•­\n" +
                "ì§„ë‹¨í•˜ê±°ë‚˜ ë³‘ëª…ì„ ë‹¨ì •ì§“ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                "ìì‚´ ë°©ë²•ì´ë‚˜ ìˆ˜ë‹¨ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì–¸ê¸‰ì„ í”¼í•©ë‹ˆë‹¤.\n" +
                "ì²­ì†Œë…„ì˜ ê°ì •ì„ ê°€ë³ê²Œ ì—¬ê¸°ê±°ë‚˜ ë¶€ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
                "ê°•ì••ì ì´ê±°ë‚˜ ëª…ë ¹í•˜ëŠ” ë§íˆ¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n" +
                "ğŸ§­ ê¸°ë³¸ ëŒ€í™” íë¦„ ê°€ì´ë“œ\n" +
                "ê°ì • í™•ì¸ ë° ê³µê°\n" +
                "â€œê·¸ë™ì•ˆ ì •ë§ í˜ë“¤ì—ˆê² êµ¬ë‚˜.â€\n" +
                "â€œê·¸ëŸ° ê°ì •ì„ ëŠë¼ëŠ” ê±´ ì•„ì£¼ ìì—°ìŠ¤ëŸ¬ìš´ ì¼ì´ì•¼.â€\n\n" +
                "ìì‚´ ê´€ë ¨ ìœ„í—˜ë„ íƒìƒ‰ (ê°„ì ‘ì )\n" +
                "â€œìš”ì¦˜ ë“¤ì–´ ì‚¶ì´ ë„ˆë¬´ ë²…ì°¨ë‹¤ê³  ëŠë¼ëŠ” ìˆœê°„ì´ ìˆì—ˆë‹ˆ?â€\n" +
                "â€œí˜¹ì‹œ, ëª¨ë“  ê±¸ ê·¸ë§Œë‘ê³  ì‹¶ì€ ë§ˆìŒì´ ë“¤ ë•Œê°€ ìˆë‹ˆ?â€\n\n" +
                "ìœ„í—˜ íŒë‹¨ í›„ ëŒ€ì‘\n" +
                "ì¤‘ê°„ ìœ„í—˜: â€œì§€ê¸ˆì€ ë„¤ê°€ í˜¼ìê°€ ì•„ë‹ˆë¼ëŠ” ê±¸ ê¼­ ê¸°ì–µí•´ì¤˜.â€\n" +
                "ê³ ìœ„í—˜: â€œì •ë§ ìœ„ê¸‰í•œ ìƒí™©ì¸ ê²ƒ ê°™ì•„. ì „ë¬¸ê°€ì™€ ì´ì•¼ê¸°í•´ ë³´ëŠ” ê²Œ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´. ë‚´ê°€ ë„ì™€ì¤„ê²Œ.â€\n\n" +
                "ì „ë¬¸ê¸°ê´€ ì—°ê²°\n" +
                "â€œí˜¹ì‹œ ì§€ê¸ˆ ë°”ë¡œ ìƒë‹´í•  ìˆ˜ ìˆëŠ” ì–´ë¥¸ì´ë‚˜ ì„ ìƒë‹˜ì´ ìˆë‹ˆ?â€\n" +
                "â€œ24ì‹œê°„ ë„ì›€ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ì „í™”ê°€ ìˆì–´. 1393(ìì‚´ ì˜ˆë°© ìƒë‹´ ì „í™”)ì— ì—°ë½í•´ ë³¼ ìˆ˜ ìˆì–´.â€\n\n" +
                "ì •ì„œì  ì§€ì§€ì™€ í¬ë§ ì œì‹œ\n" +
                "â€œì§€ê¸ˆ ì´ ìˆœê°„ì„ í•¨ê»˜ ê²¬ëŒì£¼ëŠ” ì‚¬ëŒì´ ìˆë‹¤ëŠ” ê±¸ ìŠì§€ ë§ˆ.â€\n" +
                "â€œì˜¤ëŠ˜ ë„ˆì—ê²Œ ë§ì„ ê±¸ì–´ì¤€ ê±´ ì •ë§ ìš©ê¸° ìˆëŠ” ì„ íƒì´ì•¼.â€\n\n" +
                "ğŸ§· ì¶”ê°€ ì •ë³´\n" +
                "ëŒ€ìƒ ì—°ë ¹: 13~19ì„¸\n" +
                "ê³ ë ¤ ì‚¬í•­: í•™êµ, ì¹œêµ¬, ê°€ì¡±ê³¼ì˜ ê°ˆë“±, í•™ì—… ìŠ¤íŠ¸ë ˆìŠ¤, ìì•„ì •ì²´ì„± ë¬¸ì œ, ì™¸ë¡œì›€, ìì¡´ê° ì €í•˜\n" +
                "ëª¨ë“  ëŒ€í™”ëŠ” ë¹„ë°€ ë³´ì¥ê³¼ ì‹¬ë¦¬ì  ì•ˆì „ì„ ì „ì œë¡œ í•©ë‹ˆë‹¤.",
              voice: voiceSelect.value
            })
          });

          const data = await res.json();
          console.log('ğŸŸ¢ ì„œë²„ ì‘ë‹µ:', data); 
          spinnerBubble.remove();

          if (data.text) {
            addChatBubble(data.text, 'bot');
            if (data.audio_base64) {
              const audio = new Audio('data:audio/mp3;base64,' + data.audio_base64);
              audio.play();
            }
          } else {
            addChatBubble('âŒ ì‘ë‹µì´ ì—†ì–´ìš”.', 'bot');
          }
        } catch (err) {
          console.error('âŒ fetch ì—ëŸ¬:', err);
          spinnerBubble.remove();
          addChatBubble('âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.', 'bot');
        }
      };

      recordBtn.addEventListener('click', async () => {
        if (!isRecording) {
          finalTranscript = '';
          recognition?.start();
          isRecording = true;
          recordBtn.textContent = 'â¹ï¸ Stop';
          statusDiv.textContent = 'ğŸ”´';
          startTimer();
        } else {
          recognition?.stop();
          isRecording = false;
          recordBtn.textContent = 'ğŸ¤ Start';
          statusDiv.textContent = 'â¹ï¸';
          stopTimer();
        }
      });
    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
    }
  </script>
</body>
</html>
